server:
  address: 0.0.0.0
  port: 8080 # å¾®æœå‹™ç«¯å£ï¼Œç”¨æ–¼æœ¬åœ°é–‹ç™¼å’Œæ¸¬è©¦

spring:
  web:
    resources:
      add-mappings: false

  cloud:
    consul:
      discovery:
        prefer-ip-address: true
        service-name: ${spring.application.name}
        instance-id: ${spring.application.name}-${server.port}

    gateway:
      default-filters:
        - StripPrefix=1 # ç§»é™¤è·¯å¾‘ä¸­çš„ç¬¬ä¸€å±¤å‰ç¶´
      routes:
        # æˆæ¬Šä¼ºæœå™¨è·¯ç”±
        - id: authn-service
          uri: lb://authn-service # é€šéè² è¼‰å‡è¡¡å™¨æŒ‡å‘ `authn-service`
          predicates:
            - Path=/authn/** # åŒ¹é…ä»¥ /authn/ é–‹é ­çš„è«‹æ±‚è·¯å¾‘
          filters:
            - RedirectUriValidationFilter # è‡ªå®šç¾©éæ¿¾å™¨ï¼Œç”¨æ–¼æª¢æŸ¥ `redirect_uri` æ˜¯å¦åˆæ³•

        # æˆæ¬Šæª¢æŸ¥æœå‹™è·¯ç”±
        - id: authz-service
          uri: lb://authz-service # è² è¼‰å‡è¡¡åˆ° `authz-service`
          predicates:
            - Path=/authz/** # åŒ¹é… /authz/ é–‹é ­çš„è«‹æ±‚

        # æ¬Šé™è™•ç†æœå‹™è·¯ç”±
        - id: authp-service
          uri: lb://authp-service # è² è¼‰å‡è¡¡åˆ° `authp-service`
          predicates:
            - Path=/authp/** # åŒ¹é… /authp/ é–‹é ­çš„è«‹æ±‚

        # é»‘åå–®æœå‹™è·¯ç”±
        - id: blacklist-service
          uri: lb://blacklist-service # è² è¼‰å‡è¡¡åˆ° `blacklist-service`
          predicates:
            - Path=/blacklist/** # åŒ¹é… /blacklist/ é–‹é ­çš„è«‹æ±‚

        # å¾…è¾¦äº‹é …æœå‹™è·¯ç”±
        - id: todo-service
          uri: lb://todo-service
          predicates:
            - Path=/todo/**

        # BizForm æœå‹™è·¯ç”±
        - id: VitalBizFormService
          uri: lb://VitalBizFormService # è² è¼‰å‡è¡¡åˆ° `bizform-service`
          predicates:
            - Path=/bizform/** # åŒ¹é… /bizform/ é–‹é ­çš„è«‹æ±‚

        # Genogram æœå‹™è·¯ç”± å®¶ç³»åœ–
        - id: GenogramService
          uri: lb://GenogramService # è² è¼‰å‡è¡¡åˆ° `genogram-service`
          predicates:
            - Path=/genogram/** # åŒ¹é… /genogram/ é–‹é ­çš„è«‹æ±‚

  cache:
    caffeine:
      spec: initialCapacity=100,maximumSize=500,expireAfterWrite=10m # ç·©å­˜åˆå§‹åŒ–å®¹é‡ç‚º 100ï¼Œæœ€å¤§å®¹é‡ç‚º 500ï¼Œå¯«å…¥å¾Œ 10 åˆ†é˜éæœŸ

springdoc:
  swagger-ui:
    path: /swagger-ui.html
    urls:
      - name: GSS.Vital.AuthNService
        url: /authn/v3/authn-docs
      - name: GSS.Vital.AuthPService
        url: /authp/v3/authp-docs
#      - name: authz
#        url: /authz/v3/api-docs
#      - name: blacklist
#        url: /blacklist/v3/api-docs
#      - name: todo
#        url: /todo/v3/api-docs
      - name: GSS.Vital.BizFormAPIService
        url: /bizform/swagger/v1/swagger.json

auth:
  service:
    base-url: ${AUTH_SERVICE_BASE_URL:lb://authn-service} # å‹•æ…‹é…ç½®æˆæ¬Šæœå‹™ URL

blacklist:
  service:
    # é»‘åå–®æœå‹™çš„åç¨±
    # é€™å€‹åç¨±æ‡‰èˆ‡æœå‹™è¨»å†Šä¸­å¿ƒï¼ˆå¦‚ Eurekaã€Consul æˆ– Kubernetesï¼‰ä¸­å®šç¾©çš„æœå‹™åç¨±ä¸€è‡´
    name: blacklist-service

    # é»‘åå–®æª¢æŸ¥çš„ API è·¯å¾‘
    # è©²è·¯å¾‘æœƒé™„åŠ åˆ°é»‘åå–®æœå‹™çš„åŸºç¤ URLï¼Œä¾‹å¦‚ï¼šhttp://blacklist-service/blacklist/check
    check-path: /blacklist/check

    # è«‹æ±‚é»‘åå–®æœå‹™çš„è¶…æ™‚æ™‚é–“ï¼ˆä»¥ç§’ç‚ºå–®ä½ï¼‰
    # ç•¶è¶…éè©²æ™‚é–“æ²’æœ‰éŸ¿æ‡‰æ™‚ï¼Œè«‹æ±‚å°‡è¢«è¦–ç‚ºå¤±æ•—
    timeout: 5

app:
  security:
    redirect-validation-paths:
      - "/authn/oauth" # OAuth é©—è­‰çš„è·³è½‰è·¯å¾‘
    allowed-redirect-uris:
      - "http://localhost:8080/authn/oauth/callback"           # DEV - æœ¬åœ°é–‹ç™¼æ™‚ OAuth æˆæ¬Šå›èª¿ç«¯é»ï¼ˆå¾Œç«¯è™•ç†æˆæ¬Šç¢¼ï¼‰
      - "https://cb-svc-api.vitalext.com/authn/oauth/callback" # STAGING / PROD - ä¸Šç·šç’°å¢ƒå¾Œç«¯è™•ç† OAuth æˆæ¬Šç¢¼çš„å›èª¿ç«¯é»

    # ------------------------------------------------------------
    # permit-all : é€²å…¥ Gateway æ™‚ã€Œå… Spring-Security èªè­‰ã€ï¼Œ
    #              ä½†ä¾ç„¶æœƒé€šé InternalTokenFilter é©—è­‰ JWT èˆ‡åŸºæœ¬æˆæ¬Šã€‚
    #              âœ æœªæ”œå¸¶æœ‰æ•ˆ JWT å‰‡è¿”å› 401ã€‚
    #              âœ é©ç”¨æ–¼ç™»å…¥å¾Œå¯ç›´æ¥å­˜å–ï¼Œä½†ä¸éœ€å†é€²å…¥ Spring Security çš„è·¯å¾‘ã€‚
    # ------------------------------------------------------------
    permit-all:
      # ğŸ‘‰ æä¾›ä½¿ç”¨è€…ä»¥ç³»çµ± JWT æ›å– BizForm å°ˆç”¨ JWT
      - /authn/oauth/token/exchange

      # ğŸ‘‰ è™•ç†ä½¿ç”¨è€…ç™»å‡ºï¼Œæ¸…é™¤é»‘åå–®ã€Cookie èˆ‡å¿«å–è³‡è¨Š
      - /authn/oauth/logout

      # ğŸ‘‰ æ¬Šé™æˆæ¬Šæœå‹™ï¼ŒåŒ…å«è§’è‰²ã€è³‡æºæ¬Šé™é©—è­‰ç­‰æŸ¥è©¢æ“ä½œ
      - /authz/**

      # ğŸ‘‰ æ¬Šé™èˆ‡ç§Ÿæˆ¶è¨­å®šæœå‹™ï¼ˆå»ºç«‹ã€æ›´æ–°ã€åˆªé™¤ç­‰ï¼‰
      - /authp/**

      # ğŸ‘‰ JWT é»‘åå–®ç®¡ç†ï¼Œæ”¯æ´é»‘åå–®æŸ¥è©¢èˆ‡å¿«å–åŒæ­¥
      - /blacklist/**

      # ğŸ‘‰ Todo ç®¡ç† APIï¼ˆç¯„ä¾‹æœå‹™ï¼‰
      - /todo/**

      # ğŸ‘‰ BizForm æå ±ã€åŒæ­¥ç­‰å°ˆç”¨ APIï¼Œéœ€é©—ç³»çµ± JWT èˆ‡è§’è‰²ã€åœ°å€æ¬Šé™
      - /bizform/**

      # ğŸ‘‰ å®¶ç³»åœ–æœå‹™ï¼ŒåŒ…å«æˆå“¡é—œä¿‚ç®¡ç†èˆ‡æŸ¥è©¢
      - /genogram/**

    # ------------------------------------------------------------
    # public-paths : å®Œå…¨åŒ¿åè·¯å¾‘ï¼ŒSpring Security èˆ‡ InternalTokenFilter å‡ä¸è™•ç†ã€‚
    #                âœ ç„¡éœ€æ”œå¸¶ JWTï¼Œå³å¯ç›´æ¥å­˜å–ã€‚
    #                âœ åƒ…é©ç”¨æ–¼ã€Œç„¡ç™»å…¥éœ€æ±‚ã€çš„éœæ…‹è³‡æºã€å¥åº·æª¢æŸ¥ã€å…¬å…±å…ƒè³‡æ–™ç­‰ã€‚
    #                âš ï¸ è‹¥èˆ‡å®‰å…¨ç›¸é—œï¼Œè«‹å‹¿æ”¾å…¥æ­¤å€ã€‚
    # ------------------------------------------------------------
    public-paths:
      # ---------- ğŸŒ éœæ…‹è³‡æºï¼ˆå‰ç«¯é è¨­è«‹æ±‚ï¼‰ ----------
      - "/public/**"              # DEV - é–‹ç™¼æ™‚ç”¨çš„å‰ç«¯éœæ…‹è³‡æºï¼ˆJS / CSS / img ç­‰ï¼‰
      - "/static/**"              # DEV - Spring Boot å‚³çµ± static ç›®éŒ„ï¼ˆè‹¥ä½¿ç”¨ï¼‰
      - "/favicon.ico"            # ALL - ç€è¦½å™¨é è¨­è«‹æ±‚ç¶²ç«™ icon

      # ---------- ğŸ” å¥åº·æª¢æŸ¥èˆ‡ç›£æ§ ----------
      - "/actuator/health"        # OPS - ç³»çµ±å¥åº·ç‹€æ…‹ï¼ˆä¾› LB / K8s æ¢æ´»ç”¨ï¼‰
      - "/actuator/prometheus"    # OPS - Prometheus æŒ‡æ¨™æš´éœ²ç«¯é»ï¼ˆè‹¥æœ‰å•Ÿç”¨ç›£æ§ï¼‰

      # ---------- ğŸ”‘ JWT / OIDC å…¬é–‹å”å®šç«¯é» ----------
      - "/authn/.well-known/**"   # OIDC Discovery metadata
      - "/authn/jwks/publicKey"   # JWT é©—ç°½æ‰€éœ€çš„ JWK å…¬é‘°
      - "/authn/oauth/login"      # OAuth2 æˆæ¬Šç™»å…¥èµ·é»ï¼ˆä¾›å‰ç«¯å°å‘ï¼‰
      - "/authn/oauth/callback"   # OAuth2 æˆæ¬Šç¢¼å›èª¿ç«¯é»
      - "/oauth2/authorization/**" # Spring Security OAuth2 æ ¸å¿ƒç«¯é»ï¼ˆè‡ªå‹•è¨»å†Šï¼‰

      # ---------- ğŸ“„ Swagger / OpenAPI é–‹ç™¼ç”¨æ–‡ä»¶ ----------
      - "/swagger-ui.html"        # Swagger UI é¦–é ï¼ˆHTMLï¼‰
      - "/swagger-ui/**"          # Swagger UI å‰ç«¯éœæ…‹è³‡æºï¼ˆJS / CSSï¼‰
      - "/v3/api-docs/**"         # OpenAPI æ ¼å¼çš„å¾Œç«¯æ–‡ä»¶ JSON
      - "/webjars/**"             # Swagger ç›¸é—œä¾è³´ï¼ˆJS / CSS å¥—ä»¶ï¼‰
      - "/authn/v3/authn-docs"    # AuthN èšåˆå¾Œçš„ Swagger æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ aggregator ç”¢å‡ºï¼‰

cors:
  allowed-origins:
    - "http://localhost:7001"                    # DEV - å‰ç«¯æœ¬åœ°é–‹ç™¼ç’°å¢ƒï¼ˆé€šå¸¸ä½¿ç”¨ Vite/React æœ¬åœ°å•Ÿå‹•ï¼‰
    - "https://cb-svc-web.vitalext.com"          # STAGING - VitalCaseBridge å‰ç«¯æ¸¬è©¦ç’°å¢ƒï¼ˆstaging æ¸¬è©¦ä½¿ç”¨ï¼‰
    - "https://member.vikosmos.com"              # DEV - BizForm æ¸¬è©¦ç’°å¢ƒï¼ˆç”¨æ–¼è¡¨å–®æœå‹™ç°½æ ¸æ¸¬è©¦ï¼‰
    - "https://bizform.vitalyun.com"             # STAGING - BizForm æ­£å¼ç’°å¢ƒï¼ˆå¯¦éš›å°å¤–ç°½æ ¸æœå‹™ï¼‰
    - "https://cloud-member.gss.com.tw"          # DEV - å¸³è™Ÿä¸­å¿ƒæ¸¬è©¦ç’°å¢ƒï¼ˆOAuth ç™»å…¥èˆ‡æˆæ¬Šæ¸¬è©¦ï¼‰
    - "https://member.gsscloud.com"              # STAGING - å¸³è™Ÿä¸­å¿ƒæ­£å¼ç’°å¢ƒï¼ˆå¯¦éš›ç™»å…¥èˆ‡æˆæ¬Šä¾†æºï¼‰
    - "https://demo.genogram.cloud"              # DEV - å®¶ç³»åœ–åµŒå…¥ iframe é é¢ä¾†æºï¼ˆiframe è¼‰å…¥å…è¨±è·¨åŸŸï¼‰
  allowed-methods:
    - "GET"       # æŸ¥è©¢è³‡æº
    - "POST"      # å»ºç«‹è³‡æº
    - "PUT"       # æ›´æ–°æ•´å€‹è³‡æº
    - "DELETE"    # åˆªé™¤è³‡æº
    - "OPTIONS"   # é æª¢è«‹æ±‚ï¼ˆç€è¦½å™¨è‡ªå‹•ç™¼å‡ºï¼Œç”¨æ–¼ CORS é©—è­‰ï¼‰
    - "PATCH"     # æ›´æ–°éƒ¨åˆ†æ¬„ä½ï¼ˆéƒ¨åˆ†ä¿®æ”¹è³‡æºï¼ŒRESTful å¸¸è¦‹ï¼‰

  allowed-headers:
    - "Authorization"       # JWT æˆ– OAuth Token é©—è­‰ç”¨
    - "Content-Type"        # è«‹æ±‚æ ¼å¼è²æ˜ï¼Œä¾‹å¦‚ application/json
    - "Refresh-Token"       # Refresh Tokenï¼Œç”¨æ–¼æ›ç™¼ access token
    - "X-Current-Page"      # åˆ†é ï¼šç›®å‰é æ•¸ï¼ˆå‰ç«¯è‡ªå®šç¾© headerï¼‰
    - "X-Page-Size"         # åˆ†é ï¼šæ¯é è³‡æ–™é‡
    - "X-Total-Count"       # åˆ†é ï¼šç¸½ç­†æ•¸ï¼ˆå¤šç”¨æ–¼ response headerï¼Œä½†ä¿ç•™å…è¨±è«‹æ±‚ç«¯å¸¶å…¥ï¼‰
    - "X-Requested-With"    # Ajax è«‹æ±‚è­˜åˆ¥ï¼ˆä¾‹å¦‚ XMLHttpRequestï¼ŒæŸäº› UI æ¡†æ¶æœƒè‡ªå¸¶ï¼‰
    - "Accept"              # æ¥å—çš„å›æ‡‰æ ¼å¼ï¼Œä¾‹å¦‚ application/jsonã€text/html ç­‰