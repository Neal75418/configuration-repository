server:
  port: 8080

spring:
  cloud:
    consul:
      discovery:
        prefer-ip-address: true # 🌐 優先使用 IP 註冊與健康檢查
        health-check-path: /actuator/health # ❤️ 健康檢查端點路徑
        ip-address: ${SERVICE_IP:${spring.cloud.client.ip-address}} # 🧭 服務 IP，優先用環境變數覆寫
        service-name: ${spring.application.name}  # 🏷️ 服務名稱（註冊到 Consul）
        instance-id: ${spring.application.name}-${server.port}  # 🔢 實例 ID，避免埠號衝突

  cache:
    caffeine:
      spec: initialCapacity=100,maximumSize=500,expireAfterWrite=10m # 緩存初始化容量為 100，最大容量為 500，寫入後 10 分鐘過期

springdoc:
  swagger-ui:
    path: /swagger-ui.html
    urls:
      - name: GSS.Vital.AuthNService
        url: /authn/v3/authn-docs
      - name: GSS.Vital.AuthPService
        url: /authp/v3/authp-docs
      - name: GSS.Vital.BlacklistService
        url: /blacklist/v3/blacklist-docs
      - name: GSS.Vital.TenantService
        url: /tenant/v3/tenant-docs
      - name: GSS.Vital.BizFormAPIService
        url: /bizform/swagger/v1/swagger.json
      - name: GSS.Vital.MailService
        url: /mail/swagger/v1/swagger.json
      - name: GSS.Vital.TerritoryService
        url: /territory/swagger/v1/swagger.json
      - name: GSS.Vital.ReportingService
        url: /reporting/swagger/v1/swagger.json
      - name: GSS.Vital.PettyCashService
        url: /petty-cash/swagger/v1/swagger.json
      - name: GSS.Vital.GeoSyncService
        url: /geo-sync/swagger/v1/swagger.json

gateway:
  security:
    refresh-token-path: /authn/oauth/refresh-token

auth:
  service:
    base-url: ${AUTH_SERVICE_BASE_URL:lb://authn-service} # 動態配置授權服務 URL

authn:
  internal-base-url: http://authn-service # 📡 Gateway 呼叫 AuthN 微服務的內部 URL（供 callback token 換取 access token 使用）

blacklist:
  service:
    # 黑名單服務的名稱
    # 這個名稱應與服務註冊中心（如 Eureka、Consul 或 Kubernetes）中定義的服務名稱一致
    name: blacklist-service

    # 黑名單檢查的 API 路徑
    # 該路徑會附加到黑名單服務的基礎 URL，例如：http://blacklist-service/blacklist/check
    check-path: /blacklist/check

    # 請求黑名單服務的超時時間（以秒為單位）
    # 當超過該時間沒有響應時，請求將被視為失敗
    timeout: 5

  # lastUrlByTenant（租戶 → 端點）的本地快取設定
  last-url-cache:
    # 最大快取項目數（entries）；超過會自動逐出，避免 JVM 記憶體膨脹
    # 心法：活躍租戶數 × 2~3 倍；可依環境覆蓋（application-*.yaml）
    max-size: 60000

app:
  bizform:
    query-path: /bizform/api/Documents/Query # BizForm 查詢 API 路徑
  security:
    redirect-validation-paths:
      - "/authn/oauth/authorize" # 檢查 OAuth 授權「發起端點」；路徑尚未 StripPrefix（原始 /authn/...）
      - "/oauth/authorize"       # 檢查 OAuth 授權「發起端點」；StripPrefix=1 之後實際進入過濾器的路徑
    allowed-redirect-uris:
      - "http://localhost:8080/authn/oauth/callback"           # DEV - 本地開發時 OAuth 授權回調端點（後端處理授權碼）
      - "https://cb-svc-api.vitalcb.com/authn/oauth/callback"  # SIT - SIT環境後端處理 OAuth 授權碼的回調端點
      - "https://cb-svc-api.vitalext.com/authn/oauth/callback" # UAT - UAT環境後端處理 OAuth 授權碼的回調端點

    # ------------------------------------------------------------
    # permit-all : 進入 Gateway 時「免 Spring-Security 認證」，
    #              但依然會通過 InternalTokenFilter 驗證 JWT 與基本授權。
    #              ➜ 未攜帶有效 JWT 則返回 401。
    #              ➜ 適用於登入後可直接存取，但不需再進入 Spring Security 的路徑。
    # ------------------------------------------------------------
    permit-all:
      # # 👉 使用者以「系統使用者 JWT」交換取得 BizForm 專用 JWT（user-delegation）
      - /authn/oauth/token/exchange

      # 👉 佈建階段：允許匿名呼叫以換取「無 depotId」的 BizForm Token
      #    僅能用於建立站台，不能訪問任何 BizForm 資料。
      #    ⚠️ 實際安全仍需配合 X-Bootstrap-Secret header 驗證。
      - /authn/oauth/token/exchange-bootstrap

      # 👉 服務對服務（M2M）用「機器憑證」換取 內部服務存取 Token
      - /authn/oauth2/token

      # 👉 處理使用者登出，清除黑名單、Cookie 與快取資訊
      - /authn/oauth/logout

      # 👉 提供 iframe 專用的 callback token，供外部畫面回打系統 API 使用 ⚠️ 須驗證系統 JWT，確認權限與租戶合法性
      - /authn/callback-token

      # 👉 管理權限與租戶設定（建立、更新、刪除等）
      - /authp/**

      # 👉 管理 JWT 黑名單與快取同步
      - /blacklist/**

      # 👉 管理租戶資訊、訂單與資料庫連線設定
      - /tenant/**

      # 👉 提報與同步 BizForm 表單資料，需驗系統 JWT 與權限
      - /bizform/**

      # 👉 管理與查詢家系圖成員關係
      - /genogram/**

      # 👉 發送系統通知與郵件
      - /mail/**

      # 👉 管理與查詢責任區及行政區資料
      - /territory/**

      # 👉 產製與查詢報表資料
      - /reporting/**

      # 👉 管理與核銷零用金資料
      - /petty-cash/**

      # 👉 同步指定國家的行政區資料至租戶資料庫（tenant onboarding 專用）
      - /geo-sync/**

cors:
  allowed-origins:
    - "http://localhost:7001"                    # DEV - 前端本地開發環境（通常使用 Vite/React 本地啟動）
    - "https://cb-svc-web.vitalcb.com"           # SIT - VitalCaseBridge 前端測試環境（SIT 測試使用）
    - "https://cb-svc-web.vitalext.com"          # UAT - VitalCaseBridge 前端測試環境（UAT 測試使用）
    - "https://member.vikosmos.com"              # DEV - BizForm 測試環境（用於表單服務簽核測試）
    - "https://bizform.vitalyun.com"             # UAT - BizForm 正式環境（實際對外簽核服務）
    - "https://cloud-member.gss.com.tw"          # DEV - 帳號中心測試環境（OAuth 登入與授權測試）
    - "https://member.gsscloud.com"              # UAT - 帳號中心正式環境（實際登入與授權來源）
    - "https://demo.genogram.cloud"              # DEV - 家系圖嵌入 iframe 頁面來源（iframe 載入允許跨域）
  allowed-methods:
    - "GET"       # 查詢資源
    - "POST"      # 建立資源
    - "PUT"       # 更新整個資源
    - "DELETE"    # 刪除資源
    - "OPTIONS"   # 預檢請求（瀏覽器自動發出，用於 CORS 驗證）
    - "PATCH"     # 更新部分欄位（部分修改資源，RESTful 常見）

  allowed-headers:
    - "Authorization"              # JWT 或 OAuth Token 驗證用
    - "Content-Type"               # 請求格式聲明，例如 application/json
    - "Refresh-Token"              # Refresh Token，用於換發 access token
    - "X-Current-Page"             # 分頁：目前頁數（前端自定義 header）
    - "X-Page-Size"                # 分頁：每頁資料量
    - "X-Total-Count"              # 分頁：總筆數（多用於 response header，但保留允許請求端帶入）
    - "X-Requested-With"           # Ajax 請求識別（例如 XMLHttpRequest，某些 UI 框架會自帶）
    - "Accept"                     # 接受的回應格式，例如 application/json、text/html 等
    - "X-Instance-ExpirationDate"  # 前端自訂：實例到期日。必須列入 allowed-headers，否則預檢（OPTIONS）
                                   # 的 Access-Control-Request-Headers 會被 CORS 擋下，POST 打不到後端。
                                   # 註：程式會轉小寫比對，大小寫不影響。