spring:
  web:
    resources:
      # ğŸš« é—œé–‰é è¨­ /staticã€/public ç­‰éœæ…‹è·¯å¾‘
      add-mappings: false

  cloud:
    consul:
      discovery:
        healthCheckUrl: http://api-gateway:${server.port}/actuator/health
        ip-address: ${SERVICE_IP:${spring.cloud.client.ip-address}} # IP åœ°å€ï¼Œå„ªå…ˆä½¿ç”¨å¤–éƒ¨å‚³å…¥çš„ç’°å¢ƒè®Šæ•¸

    gateway:
      server:
        webflux:
          default-filters:
            - StripPrefix=1 # ç§»é™¤è·¯å¾‘ä¸­çš„ç¬¬ä¸€å±¤å‰ç¶´
          routes:
            # æˆæ¬Šä¼ºæœå™¨è·¯ç”±
            - id: authn-service
              uri: lb://authn-service # é€šéè² è¼‰å‡è¡¡å™¨æŒ‡å‘ `authn-service`
              predicates:
                - Path=/authn/** # åŒ¹é…ä»¥ /authn/ é–‹é ­çš„è«‹æ±‚è·¯å¾‘
              filters:
                - RedirectUriValidationFilter # è‡ªå®šç¾©éæ¿¾å™¨ï¼Œç”¨æ–¼æª¢æŸ¥ `redirect_uri` æ˜¯å¦åˆæ³•

            # æˆæ¬Šæª¢æŸ¥æœå‹™è·¯ç”±
            - id: authz-service
              uri: lb://authz-service # è² è¼‰å‡è¡¡åˆ° `authz-service`
              predicates:
                - Path=/authz/** # åŒ¹é… /authz/ é–‹é ­çš„è«‹æ±‚

            # æ¬Šé™è™•ç†æœå‹™è·¯ç”±
            - id: authp-service
              uri: lb://authp-service # è² è¼‰å‡è¡¡åˆ° `authp-service`
              predicates:
                - Path=/authp/** # åŒ¹é… /authp/ é–‹é ­çš„è«‹æ±‚

            # é»‘åå–®æœå‹™è·¯ç”±
            - id: blacklist-service
              uri: lb://blacklist-service # è² è¼‰å‡è¡¡åˆ° `blacklist-service`
              predicates:
                - Path=/blacklist/** # åŒ¹é… /blacklist/ é–‹é ­çš„è«‹æ±‚

            # ç§Ÿæˆ¶æœå‹™è·¯ç”±
            - id: tenant-service
              uri: lb://tenant-service # è² è¼‰å‡è¡¡åˆ° `tenant-service`
              predicates:
                - Path=/tenant/** # åŒ¹é… /tenant/ é–‹é ­çš„è«‹æ±‚

            # å¾…è¾¦äº‹é …æœå‹™è·¯ç”±
            - id: todo-service
              uri: lb://todo-service
              predicates:
                - Path=/todo/**

            # BizForm æœå‹™è·¯ç”±
            - id: VitalBizFormService
              uri: lb://VitalBizFormService # è² è¼‰å‡è¡¡åˆ° `bizform-service`
              predicates:
                - Path=/bizform/** # åŒ¹é… /bizform/ é–‹é ­çš„è«‹æ±‚
              filters:
                - CacheRequestBody=String

            # Genogram æœå‹™è·¯ç”± å®¶ç³»åœ–
            - id: GenogramService
              uri: lb://GenogramService # è² è¼‰å‡è¡¡åˆ° `genogram-service`
              predicates:
                - Path=/genogram/** # åŒ¹é… /genogram/ é–‹é ­çš„è«‹æ±‚

            # mail æœå‹™è·¯ç”±
            - id: MailService
              uri: lb://MailService # è² è¼‰å‡è¡¡åˆ° `mail-service`
              predicates:
                - Path=/mail/** # åŒ¹é… /mail/ é–‹é ­çš„è«‹æ±‚

            # TerritoryService æœå‹™è·¯ç”±
            - id: TerritoryService
              uri: lb://TerritoryService # è² è¼‰å‡è¡¡åˆ° `territory-service`
              predicates:
                - Path=/territory/** # åŒ¹é… /territory/ é–‹é ­çš„è«‹æ±‚

            # å ±è¡¨æœå‹™è·¯ç”±
            - id: reporting-service
              uri: lb://reporting-service # è² è¼‰å‡è¡¡åˆ° `reporting-service`
              predicates:
                - Path=/reporting/** # åŒ¹é… /reporting/ é–‹é ­çš„è«‹æ±‚

            # é›¶ç”¨é‡‘æœå‹™è·¯ç”±
            - id: PettyCashService
              uri: lb://PettyCashService # è² è¼‰å‡è¡¡åˆ° `petty-cash-service`
              predicates:
                - Path=/petty-cash/** # åŒ¹é… /petty-cash/ é–‹é ­çš„è«‹æ±‚

  data:
    redis:
      host: ${REDIS_HOST:auth_redis} # Redis ä¸»æ©Ÿåœ°å€ï¼Œæ”¯æŒå¤–éƒ¨ç’°å¢ƒè®Šæ•¸é…ç½®
      port: ${REDIS_PORT:6379}      # Redis é»˜èªç«¯å£
      password: ${REDIS_PASSWORD:}  # Redis å¯†ç¢¼ï¼Œç•™ç©ºè¡¨ç¤ºç„¡å¯†ç¢¼
      timeout: 5s  # è¨­å®šé€£ç·šè¶…æ™‚ç‚º 5 ç§’
      lettuce:
        pool:
          max-active: 50      # æœ€å¤§é€£æ¥æ•¸
          max-idle: 15        # æœ€å¤§ç©ºé–’é€£æ¥æ•¸
          min-idle: 5         # æœ€å°ç©ºé–’é€£æ¥æ•¸
          max-wait: 2000ms    # æœ€å¤§ç­‰å¾…æ™‚é–“

jwt:
  issuer: ${JWT_ISSUER_URI:${spring.cloud.client.ip-address}:8080/authn} # JWT ç°½ç™¼è€…çš„ URI
  jwk-set-uri: ${JWT_JWK_SET_URI:http://${spring.cloud.client.ip-address}:8080/authn/jwks/publicKey} # JWK å…¬é‘°çš„ URI
  signature-algorithm: ES256 # ä½¿ç”¨ ECï¼ˆæ©¢åœ“æ›²ç·šï¼‰ç°½åç®—æ³•
  time-skew:
    seconds: 60 # æ™‚é–“åç§»ï¼Œå…è¨± JWT é©—è­‰æ™‚å®¹å¿çš„æ™‚å·®
  valid:
    audiences: ${JWT_VALID_AUDIENCES:${spring.cloud.client.ip-address}} # JWT çš„å—çœ¾é©—è­‰

# ğŸŒ‰ API Gateway â€“ Provisioning å°ˆç”¨è¨­å®šï¼ˆInternalTokenFilterï¼‰
provisioning:
  intake:
    gateway-bypass:
      # ç•¶ TRUEï¼š/provisioning/tenants è·¯å¾‘å³ä½¿ã€Œæ²’å¸¶/å¸¶éŒ¯ PATã€ä¹Ÿä¸å› 401ï¼Œ
      # ç›´æ¥è½‰ç™¼åˆ°ä¸‹æ¸¸ï¼Œä¸¦æ³¨å…¥æˆæ¬Šæ©‹æ¥æ¨™é ­ï¼š
      #   X-Auth-Scopes: <scope>
      #   X-Token-Id   : bypass
      #   X-Intake-Bypass: true
      # ç›®çš„ï¼šSIT/UAT å°æ¥æœŸã€Œç›¡å¯èƒ½å› 200 ä¸¦è¨˜éŒ„çœŸå¯¦ payloadã€ã€‚
      # â€» PROD ä¸€å¾‹é—œé–‰ï¼Œå¦å‰‡ä»»ä½•äººéƒ½èƒ½æ‰“åˆ°ä¸‹æ¸¸ï¼ˆå³ä½¿æ²’ PATï¼‰ã€‚
      enabled: true              # â† åªåœ¨ SIT/UAT é–‹ï¼ŒPROD é—œ

      # è¨­å®šè¦æ³¨å…¥çµ¦ä¸‹æ¸¸ Bridge çš„ scope å€¼ã€‚
      # Gateway æœƒæŠŠå®ƒæ”¾åœ¨ X-Auth-Scopesï¼›ä¸‹æ¸¸ï¼ˆauthpï¼‰Bridge æœƒè½‰æˆ SCOPE_provisioning.write æ¬Šé™ã€‚
      scope: provisioning.write  # â† è¦æ³¨å…¥çµ¦ä¸‹æ¸¸ Bridge çš„ scope

  pat:
    # ç”¨æ–¼é©—è­‰ PATï¼ˆcb_pat.<id>.<sig>ï¼‰çš„ä¸»å¯†é‘°ï¼š
    #   sig = base64url(HMAC_SHA256(id, master-secret))
    # è‹¥é©—è­‰é€šéï¼ŒGateway æœƒç§»é™¤å¤–éƒ¨ Authorizationï¼Œä¸¦æ³¨å…¥ï¼š
    #   X-Auth-Scopes: provisioning.write
    #   X-Token-Id   : <id>
    # è¨­å®šä¾†æºï¼šå„ªå…ˆè®€ç’°å¢ƒè®Šæ•¸ PROVISIONING_PAT_MASTER_SECRETï¼Œå¦å‰‡ä½¿ç”¨å†’è™Ÿå¾Œçš„é è¨­å€¼ï¼ˆåªå»ºè­°æœ¬æ©Ÿ/æ¸¬è©¦ï¼‰ã€‚
    # å®‰å…¨å»ºè­°ï¼šé•·åº¦ â‰¥ 32 bytesã€éš¨æ©Ÿã€åªæ”¾ç’°å¢ƒè®Šæ•¸ï¼Œä¸è¦ commitï¼›è¼ªæ›¿æœƒè®“èˆŠ PAT ç«‹å³å¤±æ•ˆã€‚
    master-secret: ${PROVISIONING_PAT_MASTER_SECRET:iEKqBaLCdjzq5jJsdfsdoLGorGFQZSWBcGrY6G3o3m4}   # æ”¾ç’°å¢ƒè®Šæ•¸ï¼Œéš¨æ©Ÿ 32+ bytes

springdoc:
  swagger-ui:
    enabled: false       # é—œé–‰ Swagger UI é é¢ï¼ˆ/swagger-ui.htmlï¼‰ï¼Œé¿å…åœ¨ç”Ÿç”¢ç’°å¢ƒæš´éœ² API æ–‡ä»¶
  api-docs:
    enabled: false       # é—œé–‰ OpenAPI JSON æ–‡ä»¶ï¼ˆ/v3/api-docsï¼‰ï¼Œé˜²æ­¢ API schema å¤–æ´©

app:
  security:
    # ------------------------------------------------------------
    # public-paths : å®Œå…¨åŒ¿åè·¯å¾‘ï¼ŒSpring Security èˆ‡ InternalTokenFilter å‡ä¸è™•ç†ã€‚
    #                âœ ç„¡éœ€æ”œå¸¶ JWTï¼Œå³å¯ç›´æ¥å­˜å–ã€‚
    #                âœ åƒ…é©ç”¨æ–¼ã€Œç„¡ç™»å…¥éœ€æ±‚ã€çš„éœæ…‹è³‡æºã€å¥åº·æª¢æŸ¥ã€å…¬å…±å…ƒè³‡æ–™ç­‰ã€‚
    #                âš ï¸ è‹¥èˆ‡å®‰å…¨ç›¸é—œï¼Œè«‹å‹¿æ”¾å…¥æ­¤å€ã€‚
    # ------------------------------------------------------------
    public-paths:
      # ---------- ğŸŒ éœæ…‹è³‡æºï¼ˆå‰ç«¯é è¨­è«‹æ±‚ï¼‰ ----------
      - "/public/**"              # DEV - é–‹ç™¼æ™‚ç”¨çš„å‰ç«¯éœæ…‹è³‡æºï¼ˆJS / CSS / img ç­‰ï¼‰
      - "/static/**"              # DEV - Spring Boot å‚³çµ± static ç›®éŒ„ï¼ˆè‹¥ä½¿ç”¨ï¼‰
      - "/favicon.ico"            # ALL - ç€è¦½å™¨é è¨­è«‹æ±‚ç¶²ç«™ icon

      # ---------- ğŸ” å¥åº·æª¢æŸ¥èˆ‡ç›£æ§ ----------
      - "/actuator/health"        # OPS - ç³»çµ±å¥åº·ç‹€æ…‹ï¼ˆä¾› LB / K8s æ¢æ´»ç”¨ï¼‰
      - "/actuator/prometheus"    # OPS - Prometheus æŒ‡æ¨™æš´éœ²ç«¯é»ï¼ˆè‹¥æœ‰å•Ÿç”¨ç›£æ§ï¼‰

      # ---------- ğŸ”‘ JWT / OIDC å…¬é–‹å”å®šç«¯é» ----------
      - "/authn/.well-known/**"   # OIDC Discovery metadata
      - "/authn/jwks/publicKey"   # JWT é©—ç°½æ‰€éœ€çš„ JWK å…¬é‘°
      - "/authn/oauth/login"      # OAuth2 æˆæ¬Šç™»å…¥èµ·é»ï¼ˆä¾›å‰ç«¯å°å‘ï¼‰
      - "/authn/oauth/callback"   # OAuth2 æˆæ¬Šç¢¼å›èª¿ç«¯é»
      - "/oauth2/authorization/**" # Spring Security OAuth2 æ ¸å¿ƒç«¯é»ï¼ˆè‡ªå‹•è¨»å†Šï¼‰

      # ---------- ğŸ“„ Swagger / OpenAPI é–‹ç™¼ç”¨æ–‡ä»¶ ----------
      - "/swagger-ui.html"        # Swagger UI é¦–é ï¼ˆHTMLï¼‰
      - "/swagger-ui/**"          # Swagger UI å‰ç«¯éœæ…‹è³‡æºï¼ˆJS / CSSï¼‰
      - "/v3/api-docs/**"         # OpenAPI æ ¼å¼çš„å¾Œç«¯æ–‡ä»¶ JSON
      - "/webjars/**"             # Swagger ç›¸é—œä¾è³´ï¼ˆJS / CSS å¥—ä»¶ï¼‰

# æŒ‡å®šä½¿ç”¨ log4j2-logstash.xml ä½œç‚º logging è¨­å®šæª”ï¼Œå•Ÿç”¨ Logstash è¼¸å‡º
logging:
  config: classpath:log4j2-logstash.xml

test:
  depot-id: ee197c49e2e9449c8b48874a45a1611d