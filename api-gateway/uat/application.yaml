spring:
  web:
    resources:
      # ğŸš« é—œé–‰é è¨­ /staticã€/public ç­‰éœæ…‹è·¯å¾‘
      add-mappings: false

  cloud:
    consul:
      discovery:
        healthCheckUrl: http://api-gateway:${server.port}/actuator/health
        ip-address: ${SERVICE_IP:${spring.cloud.client.ip-address}} # IP åœ°å€ï¼Œå„ªå…ˆä½¿ç”¨å¤–éƒ¨å‚³å…¥çš„ç’°å¢ƒè®Šæ•¸

    gateway:
      default-filters:
        - StripPrefix=1 # ç§»é™¤è·¯å¾‘ä¸­çš„ç¬¬ä¸€å±¤å‰ç¶´
      routes:
        # æˆæ¬Šä¼ºæœå™¨è·¯ç”±
        - id: authn-service
          uri: lb://authn-service # é€šéè² è¼‰å‡è¡¡å™¨æŒ‡å‘ `authn-service`
          predicates:
            - Path=/authn/** # åŒ¹é…ä»¥ /authn/ é–‹é ­çš„è«‹æ±‚è·¯å¾‘
          filters:
            - RedirectUriValidationFilter # è‡ªå®šç¾©éæ¿¾å™¨ï¼Œç”¨æ–¼æª¢æŸ¥ `redirect_uri` æ˜¯å¦åˆæ³•

        # æˆæ¬Šæª¢æŸ¥æœå‹™è·¯ç”±
        - id: authz-service
          uri: lb://authz-service # è² è¼‰å‡è¡¡åˆ° `authz-service`
          predicates:
            - Path=/authz/** # åŒ¹é… /authz/ é–‹é ­çš„è«‹æ±‚

        # æ¬Šé™è™•ç†æœå‹™è·¯ç”±
        - id: authp-service
          uri: lb://authp-service # è² è¼‰å‡è¡¡åˆ° `authp-service`
          predicates:
            - Path=/authp/** # åŒ¹é… /authp/ é–‹é ­çš„è«‹æ±‚

        # é»‘åå–®æœå‹™è·¯ç”±
        - id: blacklist-service
          uri: lb://blacklist-service # è² è¼‰å‡è¡¡åˆ° `blacklist-service`
          predicates:
            - Path=/blacklist/** # åŒ¹é… /blacklist/ é–‹é ­çš„è«‹æ±‚

        # å¾…è¾¦äº‹é …æœå‹™è·¯ç”±
        - id: todo-service
          uri: lb://todo-service
          predicates:
            - Path=/todo/**

        # BizForm æœå‹™è·¯ç”±
        - id: VitalBizFormService
          uri: lb://VitalBizFormService # è² è¼‰å‡è¡¡åˆ° `bizform-service`
          predicates:
            - Path=/bizform/** # åŒ¹é… /bizform/ é–‹é ­çš„è«‹æ±‚
          filters:
            - CacheRequestBody=String

        # Genogram æœå‹™è·¯ç”±ï¼ˆå®¶ç³»åœ–ï¼‰
        - id: GenogramService
          uri: lb://GenogramService # è² è¼‰å‡è¡¡åˆ° `genogram-service`
          predicates:
            - Path=/genogram/** # åŒ¹é… /genogram/ é–‹é ­çš„è«‹æ±‚

        # Mail æœå‹™è·¯ç”±
        - id: MailService
          uri: lb://MailService # è² è¼‰å‡è¡¡åˆ° `mail-service`
          predicates:
            - Path=/mail/** # åŒ¹é… /mail/ é–‹é ­çš„è«‹æ±‚

  data:
    redis:
      host: ${REDIS_HOST:auth_redis} # Redis ä¸»æ©Ÿåœ°å€ï¼Œæ”¯æŒå¤–éƒ¨ç’°å¢ƒè®Šæ•¸é…ç½®
      port: ${REDIS_PORT:6379}      # Redis é»˜èªç«¯å£
      password: ${REDIS_PASSWORD:}  # Redis å¯†ç¢¼ï¼Œç•™ç©ºè¡¨ç¤ºç„¡å¯†ç¢¼
      timeout: 5s  # è¨­å®šé€£ç·šè¶…æ™‚ç‚º 5 ç§’
      lettuce:
        pool:
          max-active: 50      # æœ€å¤§é€£æ¥æ•¸
          max-idle: 15        # æœ€å¤§ç©ºé–’é€£æ¥æ•¸
          min-idle: 5         # æœ€å°ç©ºé–’é€£æ¥æ•¸
          max-wait: 2000ms    # æœ€å¤§ç­‰å¾…æ™‚é–“

jwt:
  issuer: ${JWT_ISSUER_URI:${spring.cloud.client.ip-address}:8080/authn} # JWT ç°½ç™¼è€…çš„ URI
  jwk-set-uri: ${JWT_JWK_SET_URI:http://${spring.cloud.client.ip-address}:8080/authn/jwks/publicKey} # JWK å…¬é‘°çš„ URI
  signature-algorithm: ES256 # ä½¿ç”¨ ECï¼ˆæ©¢åœ“æ›²ç·šï¼‰ç°½åç®—æ³•
  time-skew:
    seconds: 60 # æ™‚é–“åç§»ï¼Œå…è¨± JWT é©—è­‰æ™‚å®¹å¿çš„æ™‚å·®
  valid:
    audiences: ${JWT_VALID_AUDIENCES:${spring.cloud.client.ip-address}} # JWT çš„å—çœ¾é©—è­‰

springdoc:
  swagger-ui:
    enabled: false       # é—œé–‰ Swagger UI é é¢ï¼ˆ/swagger-ui.htmlï¼‰ï¼Œé¿å…åœ¨ç”Ÿç”¢ç’°å¢ƒæš´éœ² API æ–‡ä»¶
  api-docs:
    enabled: false       # é—œé–‰ OpenAPI JSON æ–‡ä»¶ï¼ˆ/v3/api-docsï¼‰ï¼Œé˜²æ­¢ API schema å¤–æ´©

app:
  security:
    # ------------------------------------------------------------
    # public-paths : å®Œå…¨åŒ¿åè·¯å¾‘ï¼ŒSpring Security èˆ‡ InternalTokenFilter å‡ä¸è™•ç†ã€‚
    #                âœ ç„¡éœ€æ”œå¸¶ JWTï¼Œå³å¯ç›´æ¥å­˜å–ã€‚
    #                âœ åƒ…é©ç”¨æ–¼ã€Œç„¡ç™»å…¥éœ€æ±‚ã€çš„éœæ…‹è³‡æºã€å¥åº·æª¢æŸ¥ã€å…¬å…±å…ƒè³‡æ–™ç­‰ã€‚
    #                âš ï¸ è‹¥èˆ‡å®‰å…¨ç›¸é—œï¼Œè«‹å‹¿æ”¾å…¥æ­¤å€ã€‚
    # ------------------------------------------------------------
    public-paths:
      # ---------- ğŸŒ éœæ…‹è³‡æºï¼ˆå‰ç«¯é è¨­è«‹æ±‚ï¼‰ ----------
      - "/public/**"              # DEV - é–‹ç™¼æ™‚ç”¨çš„å‰ç«¯éœæ…‹è³‡æºï¼ˆJS / CSS / img ç­‰ï¼‰
      - "/static/**"              # DEV - Spring Boot å‚³çµ± static ç›®éŒ„ï¼ˆè‹¥ä½¿ç”¨ï¼‰
      - "/favicon.ico"            # ALL - ç€è¦½å™¨é è¨­è«‹æ±‚ç¶²ç«™ icon

      # ---------- ğŸ” å¥åº·æª¢æŸ¥èˆ‡ç›£æ§ ----------
      - "/actuator/health"        # OPS - ç³»çµ±å¥åº·ç‹€æ…‹ï¼ˆä¾› LB / K8s æ¢æ´»ç”¨ï¼‰
      - "/actuator/prometheus"    # OPS - Prometheus æŒ‡æ¨™æš´éœ²ç«¯é»ï¼ˆè‹¥æœ‰å•Ÿç”¨ç›£æ§ï¼‰

      # ---------- ğŸ”‘ JWT / OIDC å…¬é–‹å”å®šç«¯é» ----------
      - "/authn/.well-known/**"   # OIDC Discovery metadata
      - "/authn/jwks/publicKey"   # JWT é©—ç°½æ‰€éœ€çš„ JWK å…¬é‘°
      - "/authn/oauth/login"      # OAuth2 æˆæ¬Šç™»å…¥èµ·é»ï¼ˆä¾›å‰ç«¯å°å‘ï¼‰
      - "/authn/oauth/callback"   # OAuth2 æˆæ¬Šç¢¼å›èª¿ç«¯é»
      - "/oauth2/authorization/**" # Spring Security OAuth2 æ ¸å¿ƒç«¯é»ï¼ˆè‡ªå‹•è¨»å†Šï¼‰

      # ---------- ğŸ“„ Swagger / OpenAPI é–‹ç™¼ç”¨æ–‡ä»¶ ----------
      - "/swagger-ui.html"        # Swagger UI é¦–é ï¼ˆHTMLï¼‰
      - "/swagger-ui/**"          # Swagger UI å‰ç«¯éœæ…‹è³‡æºï¼ˆJS / CSSï¼‰
      - "/v3/api-docs/**"         # OpenAPI æ ¼å¼çš„å¾Œç«¯æ–‡ä»¶ JSON
      - "/webjars/**"             # Swagger ç›¸é—œä¾è³´ï¼ˆJS / CSS å¥—ä»¶ï¼‰
      - "/bizform/**"             # BIZFORM - åµŒå…¥å¼è¡¨å–®æˆ– iframe é¡¯ç¤ºå…§å®¹ï¼ˆè‹¥éå…¨é–‹æ”¾å»ºè­°è‡ªè¡Œæ§æ¬Šï¼‰

# æŒ‡å®šä½¿ç”¨ log4j2-logstash.xml ä½œç‚º logging è¨­å®šæª”ï¼Œå•Ÿç”¨ Logstash è¼¸å‡º
logging:
  config: classpath:log4j2-logstash.xml

test:
  depot-id: ee197c49e2e9449c8b48874a45a1611d